```{r rephosp, cache=cacheon}

# add 1 to all hosp in order to account to initial hospitalization
rsdata <- rsdata %>%
  mutate(
    sos_out_nohosphf6m_cat = factor(case_when(
      sos_out_nohosphf6m == 0 ~ 1,
      sos_out_nohosphf6m <= 2 ~ 2,
      sos_out_nohosphf6m <= 5 ~ 3,
      sos_out_nohosphf6m >= 6 ~ 4
    ),
    levels = 1:4,
    labels = c("1", "2-3", "4-6", ">=7")
    ),
    sos_out_nohosphf1y_cat = factor(case_when(
      sos_out_nohosphf1y == 0 ~ 1,
      sos_out_nohosphf1y <= 2 ~ 2,
      sos_out_nohosphf1y <= 5 ~ 3,
      sos_out_nohosphf1y >= 6 ~ 4
    ),
    levels = 1:4,
    labels = c("1", "2-3", "4-6", ">=7")
    ),
    sos_out_nohosphf2y_cat = factor(case_when(
      sos_out_nohosphf2y == 0 ~ 1,
      sos_out_nohosphf2y <= 2 ~ 2,
      sos_out_nohosphf2y <= 5 ~ 3,
      sos_out_nohosphf2y >= 6 ~ 4
    ),
    levels = 1:4,
    labels = c("1", "2-3", "4-6", ">=7")
    ),
    sos_out_nohosphf3y_cat = factor(case_when(
      sos_out_nohosphf3y == 0 ~ 1,
      sos_out_nohosphf3y <= 2 ~ 2,
      sos_out_nohosphf3y <= 5 ~ 3,
      sos_out_nohosphf3y >= 6 ~ 4
    ),
    levels = 1:4,
    labels = c("1", "2-3", "4-6", ">=7")
    )
  )

bardatafunc <- function(data2, treat2, time, minfollowup, timevalue) {
  treatvar <- paste0("ddr_", treat2, "_post", time)
  hfhospvar <- paste0("sos_out_nohosphf", time, "_cat")

  bardata <- data2 %>%
    filter(
      sos_outtime_death >= minfollowup
    ) %>%
    group_by(!!sym(hfhospvar)) %>%
    count(!!sym(treatvar)) %>%
    mutate(
      freq = (n / sum(n)) * 100,
      ntot = sum(n)
    ) %>%
    ungroup() %>%
    filter(!!sym(treatvar) == "No") %>%
    mutate(time = timevalue) %>%
    rename(sos_out_nohosphfall = !!sym(hfhospvar)) %>%
    select(sos_out_nohosphfall, time, ntot, freq)
}

reptreatbar <- function(data, treat, ymax = 100) {
  bardata6m <- bardatafunc(
    data2 = data,
    treat2 = treat,
    time = "6m",
    minfollowup = 365,
    timevalue = 0
  )

  bardata1y <- bardatafunc(
    data2 = data,
    treat2 = treat,
    time = "1y",
    minfollowup = 365 * 1.5,
    timevalue = 1
  )

  bardata2y <- bardatafunc(
    data2 = data,
    treat2 = treat,
    time = "2y",
    minfollowup = 365 * 2.5,
    timevalue = 2
  )

  bardata3y <- bardatafunc(
    data2 = data,
    treat2 = treat,
    time = "3y",
    minfollowup = 365 * 3.5,
    timevalue = 3
  )

  bardataall <- bind_rows(bardata6m, bardata1y, bardata2y, bardata3y) %>%
    mutate(time = factor(time, levels = c(0:3), labels = c("6 mo", "1 yr", "2 yrs", "3 yrs")))

  ggplot(
    bardataall,
    aes(x = time, y = freq, fill = sos_out_nohosphfall)
  ) +
    geom_bar(stat = "identity", position = position_dodge()) +
    ylim(0, ymax) +
    scale_fill_manual("Number of HF hospitalizations",
      values = global_kicols
    ) +
    theme_minimal() +
    ylab("Percent discontinued") +
    xlab("Time after first HF hospitalization") +
    geom_text(aes(label = ntot),
      vjust = -1, color = "black",
      position = position_dodge(.9), size = 3
    )
}
```


```{r rephospmra, fig.cap = "Repeated HF hospitalizations vs discontinuation of MRA (HFrEF, HFmrEF & HFpEF combined), n in each group over bars", cache=cacheon, dependson="rephosp"}
reptreatbar(
  data = rsdata %>% filter(
    shf_ef_cat %in% c("HFrEF", "HFmrEF", "HFpEF"),
    ddr_mra_prior == "Yes",
    sos_location == "HF in-patient"
  ),
  treat = "mra", ymax = 50
)
```

```{r rephospras, fig.cap = "Repeated HF hospitalizations vs discontinuation of RASi (HFrEF & HFmrEF combined), n in each group over bars", cache=cacheon, dependson="rephosp"}
reptreatbar(
  data =
    rsdata %>% filter(
      shf_ef_cat %in% c("HFrEF", "HFmrEF"),
      ddr_rasi_prior == "Yes",
      sos_location == "HF in-patient"
    ),
  treat = "rasi", ymax = 35
)
```

```{r rephospbbl, fig.cap = "Repeated HF hospitalizations vs discontinuation of Bbl (HFrEF & HFmrEF combined), n in each group over bars", cache=cacheon, dependson="rephosp"}
reptreatbar(
  data = rsdata %>% filter(
    shf_ef_cat %in% c("HFrEF", "HFmrEF"),
    ddr_bbl_prior == "Yes",
    sos_location == "HF in-patient"
  ),
  "bbl", ymax = 25
)
```
